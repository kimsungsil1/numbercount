<script>
    let currentNumber = 1;
    let counting = false;
    let isPaused = false;
    let voices = [];
    const counterDisplay = document.getElementById("counter");
    const startNumberInput = document.getElementById("startNumber");
    const endNumberInput = document.getElementById("endNumber");
    const rateInput = document.getElementById("rate");
    const rateValue = document.getElementById("rateValue");
    const volumeInput = document.getElementById("volume");
    const volumeValue = document.getElementById("volumeValue");
    const voiceSelect = document.getElementById("voiceSelect");
    const nightModeToggle = document.getElementById("nightModeToggle");
    const body = document.body;
    const countDirectionSelect = document.getElementById("countDirection");
    const pauseResumeBtn = document.getElementById("pauseResumeBtn");
    const startBtn = document.getElementById("startBtn");

    // 기능 6: 음성 선택 기능 구현
    function populateVoiceList() {
        voices = window.speechSynthesis.getVoices();
        
        // voices가 비어있으면 조금 후 다시 시도 (보통 음성 목록이 비동기적으로 로드됨)
        if (voices.length === 0) {
            setTimeout(populateVoiceList, 100);
            return;
        }

        // 음성 목록 초기화
        voiceSelect.innerHTML = '';
        voices.forEach((voice) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.value = voice.name;
            voiceSelect.appendChild(option);
        });

        // 기본 음성 선택 (한국어 음성 우선 선택)
        const defaultVoice = voices.find(voice => voice.lang.startsWith('ko')) || voices[0];
        if (defaultVoice) {
            voiceSelect.value = defaultVoice.name;
        }

        // 시작 버튼 활성화
        startBtn.disabled = false;
    }

    // 페이지 로드 시 음성 목록 초기화
    populateVoiceList();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
    }

    // 음성 속도 및 음량 값 표시 업데이트
    rateInput.addEventListener('input', () => {
        rateValue.textContent = rateInput.value;
    });
    volumeInput.addEventListener('input', () => {
        volumeValue.textContent = volumeInput.value;
    });

    // 나이트 모드 토글 기능
    let isNightMode = false;
    nightModeToggle.addEventListener('click', () => {
        isNightMode = !isNightMode;
        if (isNightMode) {
            body.classList.add('night-mode');
            nightModeToggle.textContent = '나이트 모드 끄기';
        } else {
            body.classList.remove('night-mode');
            nightModeToggle.textContent = '나이트 모드 켜기';
        }
    });

    // 숫자를 읽는 함수
    function speakNumber(number) {
        const utterance = new SpeechSynthesisUtterance(number.toString());
        const selectedVoiceName = voiceSelect.value;
        utterance.voice = voices.find(voice => voice.name === selectedVoiceName);

        // 선택한 음성을 사용할 수 없을 때 경고
        if (!utterance.voice) {
            alert('선택한 음성을 사용할 수 없습니다. 다른 음성을 선택해주세요.');
            return;
        }

        utterance.rate = parseFloat(rateInput.value);
        utterance.volume = parseFloat(volumeInput.value);

        // utterance의 onend 이벤트에 다음 숫자를 호출하도록 설정
        utterance.onend = function() {
            if (counting && !isPaused) {
                if (isCountingUp) {
                    currentNumber++;
                    if (currentNumber > endNumber) {
                        counting = false;
                        pauseResumeBtn.textContent = '일시 정지';
                        return;
                    }
                } else {
                    currentNumber--;
                    if (currentNumber < endNumber) {
                        counting = false;
                        pauseResumeBtn.textContent = '일시 정지';
                        return;
                    }
                }
                count();
            }
        };

        // 숫자 표시 업데이트
        counterDisplay.textContent = number;

        // 일시 정지 상태가 아닐 때만 발화
        if (!isPaused) {
            window.speechSynthesis.speak(utterance);
        }
    }

    let isCountingUp = true; // 카운팅 방향을 나타내는 변수
    let endNumber = 1;

    // 카운팅 시작 함수
    function startCounting() {
        if (counting) return;
        const startNum = parseInt(startNumberInput.value);
        const endNum = parseInt(endNumberInput.value);
        const countDirection = countDirectionSelect.value;

        if (isNaN(startNum) || isNaN(endNum)) {
            alert('시작 숫자와 끝 숫자를 올바르게 입력하세요.');
            return;
        }

        if (startNum === endNum) {
            alert('시작 숫자와 끝 숫자가 같습니다.');
            return;
        }

        isCountingUp = countDirection === 'up';
        currentNumber = startNum;
        endNumber = endNum;

        // 카운팅 방향에 따른 유효성 검사
        if (isCountingUp && startNum > endNum) {
            alert('증가 카운팅 시 시작 숫자는 끝 숫자보다 작아야 합니다.');
            return;
        } else if (!isCountingUp && startNum < endNum) {
            alert('감소 카운팅 시 시작 숫자는 끝 숫자보다 커야 합니다.');
            return;
        }

        counting = true;
        isPaused = false;
        pauseResumeBtn.textContent = '일시 정지';
        count();
    }

    // 카운팅 중지 함수
    function stopCounting() {
        counting = false;
        isPaused = false;
        window.speechSynthesis.cancel();
        pauseResumeBtn.textContent = '일시 정지';
        counterDisplay.textContent = '0';
    }

    // 일시 정지 및 재개 함수
    function pauseResumeCounting() {
        if (!counting) return;
        if (!isPaused) {
            // 일시 정지
            isPaused = true;
            window.speechSynthesis.pause();
            pauseResumeBtn.textContent = '재개';
        } else {
            // 재개
            isPaused = false;
            window.speechSynthesis.resume();
            pauseResumeBtn.textContent = '일시 정지';
        }
    }

    // 카운팅 함수
    function count() {
        if (!counting || isPaused) return;

        speakNumber(currentNumber);
    }

    // 이벤트 리스너 등록
    startBtn.addEventListener("click", startCounting);
    document.getElementById("stopBtn").addEventListener("click", stopCounting);
    pauseResumeBtn.addEventListener("click", pauseResumeCounting);
</script>
